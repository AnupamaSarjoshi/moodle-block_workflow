YUI.add("moodle-block_workflow-comments",function(e,t){var n="blocks_workflow_comments",r="commentsBase",i="/blocks/workflow/ajax.php",s="stateid",o="editorhtml",u="editorid",a="editorname",f={BLOCKWORKFLOW:"block_workflow",BLOCKCOMMENTS:"block_workflow_comments",BLOCKCOMMBTN:"block_workflow_editcommentbutton",BLOCKFINISHBTN:"block_workflow_finishstepbutton",PANEL:"block-workflow-panel",CONTENT:"content",COMMENTS:"wkf-comments",LIGHTBOX:"loading-lightbox",LOADINGICON:"loading-icon",TEXTAREA:"wfk-textarea",SUBMIT:"wfk-submit",HIDDEN:"hidden"},l=new M.core.dialogue({visible:!1,lightbox:!0,width:"auto",zIndex:100}),c=function(){c.superclass.constructor.apply(this,arguments)};e.extend(c,e.Base,{_formSubmitEvent:null,_escCloseEvent:null,_closeButtonEvent:null,_loadingNode:null,initializer:function(){l.hide(),this.set(r,e.Node.create('<div class="'+f.PANEL+'"></div>').append(e.Node.create('<div class="'+f.COMMENTS+'"></div>').append(e.Node.create('<div class="'+f.TEXTAREA+'"></div>').append(e.Node.create(this.get(o)))).append(e.Node.create('<div class="'+f.SUBMIT+'"></div>').append(e.Node.create('<input type="button" class="submitbutton"/>')))).append(e.Node.create('<div class="'+f.LIGHTBOX+" "+f.HIDDEN+'"></div>').append(e.Node.create('<img alt="loading" class="'+f.LOADINGICON+'" />').setAttribute("src",M.util.image_url("i/loading","moodle"))).setStyle("opacity",.5))),this._loadingNode=this.get(r).one("."+f.LIGHTBOX),l.set("bodyContent",this.get(r)),this.attachEvents()},show:function(t,n){t.halt(),n?(l.set("headerContent",M.str.block_workflow.finishstep),this.get(r).one("."+f.SUBMIT+" input").set("value",M.str.block_workflow.finishstep),this._formSubmitEvent=e.one("."+f.SUBMIT+" input").on("click",this.finishstep,this)):(l.set("headerContent",M.str.block_workflow.editcomments),this.get(r).one("."+f.SUBMIT+" input").set("value",M.str.moodle.savechanges),this._formSubmitEvent=e.one("."+f.SUBMIT+" input").on("click",this.save,this)),l.show(),this._escCloseEvent=e.on("key",this.hide,document.body,"down:27",this),e.Event.purgeElement(e.one(".moodle-dialogue-hd .closebutton"),!0),this._closeButtonEvent=e.on("click",this.hide,e.one(".moodle-dialogue-hd .closebutton"),this);var o={sesskey:M.cfg.sesskey,action:"getcomment",stateid:this.get(s)},a=tinyMCE.get(this.get(u)),c=tinymce.DOM.get(this.get(u)+"_ifr"),h=tinymce.DOM.getSize(c);h.h===30&&a.theme.resizeTo(h.w,90),e.io(M.cfg.wwwroot+i,{method:"POST",data:build_querystring(o),on:{start:this.displayLoading,complete:function(t,n){var r;try{r=e.JSON.parse(n.responseText);if(r.error)return new M.core.ajaxException(r)}catch(i){new M.core.exception(i)}a.setContent(r.response.comment)},end:this.removeLoading},context:this})},hide:function(){l.hide(),this._escCloseEvent&&(this._escCloseEvent.detach(),this._escCloseEvent=null),this._closeButtonEvent&&(this._closeButtonEvent.detach(),this._closeButtonEvent=null),this._formSubmitEvent&&(this._formSubmitEvent.detach(),this._formSubmitEvent=null)},save:function(){var t=tinyMCE.get(this.get(u)),n=e.one("."+f.BLOCKWORKFLOW+" ."+f.BLOCKCOMMENTS),r={sesskey:M.cfg.sesskey,action:"savecomment",stateid:this.get(s),text:t.getContent(),format:document.getElementsByName(this.get(a)+"[format]")[0].value};e.io(M.cfg.wwwroot+i,{method:"POST",data:build_querystring(r),on:{start:this.displayLoading,complete:function(t,r){var i;try{i=e.JSON.parse(r.responseText);if(i.error)return new M.core.ajaxException(i)}catch(s){new M.core.exception(s)}i.response.blockcomments?n.setContent(i.response.blockcomments):n.setContent(M.str.block_workflow.nocomments)},end:this.removeLoading},context:this}),this.hide()},finishstep:function(){var t=tinyMCE.get(this.get(u)),n=e.one("."+f.BLOCKWORKFLOW+" ."+f.CONTENT),r={sesskey:M.cfg.sesskey,action:"finishstep",stateid:this.get(s),text:t.getContent(),format:document.getElementsByName(this.get(a)+"[format]")[0].value};e.io(M.cfg.wwwroot+i,{method:"POST",data:build_querystring(r),on:{start:this.displayLoading,complete:function(t,r){var i;try{i=e.JSON.parse(r.responseText);if(i.error)return new M.core.ajaxException(i)}catch(o){new M.core.exception(o)}if(i.response.blockcontent){n.setContent(i.response.blockcontent),i.response.stateid&&(this.set(s,i.response.stateid),this.attachEvents(),M.blocks_workflow.init_todolist({stateid:i.response.stateid}));if(i.response.listworkflows){var u=n.one(".singleselect form").getAttribute("id"),a=n.one(".singleselect form select").getAttribute("id");M.util.init_select_autosubmit(e,u,a,"")}}},end:this.removeLoading},context:this}),this.hide()},displayLoading:function(){this._loadingNode.removeClass(f.HIDDEN)},removeLoading:function(){this._loadingNode.addClass(f.HIDDEN)},attachEvents:function(){var t=e.one("."+f.BLOCKCOMMBTN+" input");t&&t.on("click",this.show,this,!1);var n=e.one("."+f.BLOCKFINISHBTN+" input");n&&n.on("click",this.show,this,!0)}},{NAME:n,ATTRS:{stateid:{value:null},editorhtml:{validator:e.Lang.isString,value:null},editorid:{value:null},editorname:{validator:e.Lang.isString,value:null}}}),M.blocks_workflow=M.blocks_workflow||{},M.blocks_workflow.init_comments=function(e){return new c(e)}},"@VERSION@",{requires:["base","overlay","moodle-core-notification"]});
